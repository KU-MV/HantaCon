<html>
  <head>
    <title>Hantacon</title>
    <link rel="stylesheet" href="./main.css">
  </head>  
  <body>

    <div class="refs" style="display: none">
    </div>

    <div class="config" style="display: none">
        <input id="basePath", type="text", value="">
        <input id="dataPath", type="text", value="">
    </div>
    <div class="step-page step-0" style="height: 600; display: none;">
        <div style="text-align: center; margin-top: 30;">
          <img src="./img/top.png" style="width: 70%; height: 70%;">
        </div>

        <div style="width: 100%; height: 50; margin-top: 10; margin-bottom: 10;">
          <button class="step-0-next" onclick="showPage(1)">
            <img src="./img/Search.png">
            <label>테스트</label>
          </button>

        </div>
    </div>
    <div style="text-align: left; margin-top: 30; margin-left: 30;">
      <img src="./img/top.png">
    </div>

    
    
    
    <div class="step-page step-1" style="height: 600;">
      <div class="listview" style="width : 100%; height: 500px; border: none 10px; overflow-y: scroll; margin-top: 15;">
      </div>
      
      
      <div class="progress">
        <progress value="0" max="100" style="height: 35px; width : 100%;"></progress>
      </div>
      
      <div class="button">
        <div>
          <button class="file disabled-event">
            <img src="./img/Search.png">
            <label>Find fasta</label>
          </button>

          <button class="allSelect disabled-event" onclick="allSelect()">
            <img src="./img/selection.jpg">
            <label>All select</label>
          </button>
    
          <button class="delete disabled-event" onclick="deleteItems()">
            <img src="./img/delete.png">
            <label>Remove</label>
          </button>
    
          <button class="folder">
            <img src="./img/folder.png">
            <label>Result</label>
          </button>
          
          <button class="run disabled-event">
            <img src="./img/Run.png">
            <label>Run</label>
          </button>
    
          <button class="run disabled-event" onclick="showPage(2)">
            <img src="./img/Run.png">
            <label>Nextstrain Start</label>
          </button>

          <label style="margin-left: 15; font-size:18px; display: flex; align-items: center; float:left; margin-left: 15; margin-top: 3;"> Threshold
            <input type="number" class="spinner" id="threshold" min="0" max="9999" step="1" value="10" style="width: 60; height: 25; font-size:18px; margin-left: 15;">
          </label>
          <a style="margin-left: 15; font-size:18px; display: flex; align-items: center; float:left; margin-left: 15; margin-top: 3;" target="_blank" rel="noopener noreferrer" href="https://auspice.us/">auspice.us</a>
        </div>
        
      </div>
    </div>



    <div class="step-page step-2" style="height: 600; display: none;"> 
      <div class="sub-option" style="width : 100%; height: 500px; margin-top: 15; justify-content: center; display: flex;">
        <table>
          <tr>
            <th>virus</th>
            <td><input type="text" id="virus"></td>
            <th>accession</th>
            <td><input type="text" id="accession"></td>
            <th>date</th>
            <td><input type="text" id="date"></td>
          </tr>
          <tr>
            <th>host</th>
            <td><input type="text" id="host"></td>
            <th>region</th>
            <td><input type="text" id="region"></td>
            <th>country</th>
            <td><input type="text" id="country"></td>
          </tr>
          <tr>
            <th>city</th>
            <td><input type="text" id="city"></td>
            <th>town</th>
            <td><input type="text" id="town"></td>
            <th>db</th>
            <td><input type="text" id="db"></td>
          </tr>
          <tr>
            <th>author</th>
            <td><input type="text" id="author"></td>
            <th>url</th>
            <td><input type="text" id="url"></td>
            <th>title</th>
            <td><input type="text" id="title"></td>
          </tr>
          <tr>
            <th>journal</th>
            <td><input type="text" id="journal"></td>
            <th>paper_url</th>
            <td><input type="text" id="paper_url"></td>
          </tr>
        </table>
      </div>

      <div class="button">
        <button class="run-auspice disabled-event">
          <img src="./img/Search.png">
          <label>Auspice Start</label>
        </button>
        <button class="run-nextstrain disabled-event">
          <img src="./img/Search.png">
          <label>Nextstrain Start</label>
        </button>
        <button class="back disabled-event" onclick="showPage(1)">
          <img src="./img/Search.png">
          <label>Back</label>
        </button>
      </div>
    </div>
    

    </div>
    <div style="width: 100%; height: 100; margin-top: 10; margin-bottom: 10;">
      <table>
        <tr>
          <td>
            <div style="margin-left: 15; width: 75; display: flex; vertical-align: middle;">
              <img src="./img/KU.png">
            </div>
          </td>
          <td>
            <div  style="margin-left: 15;  width: 305; display: flex; vertical-align: middle;">
              <img src="./img/NRF.png" >
            </div>
          </td>
          <td>
            <div  style="width:50%; float:left; margin-left: 15; width: 700; text-align:left;">
              <span>
                This work is made possible by the open sharing of genetic data by various research groups. These results were generated by the Korea university (Project Instructor: Name) in Republic of Korea. This project was supported by the Research Program To Solve Social Issues of the National Research Foundation of Korea (NRF) funded by the Ministry of Science and ICT (NRF-2023000000).
                Built with KU-HantaCon. Maintained by Jin-Won Song (Korea University).
              </span>
            </div>
          </td>
        </tr>
      </table>
    </div>




  </body>
  <script src="./jquery-3.7.0.min.js"></script>
  <script>
    
    itme_index = 0;
    
    document.querySelector('button.file').addEventListener('click', () => {
      file_find.openDialog();
    });

    //document.querySelector('button.run').addEventListener('click', () => {
    //  file_find.runShell(chkItems());
    //});
    
    document.querySelector('button.run-auspice').addEventListener('click', () => {
      file_find.auspice();
    });

    document.querySelector('button.run').addEventListener('click', () => {
      file_find.runShell(chkItems(false));
    });

    document.querySelector('button.run-nextstrain').addEventListener('click', () => {
      file_find.runShell(chkItems(true));
    });

    document.querySelector('button.folder').addEventListener('click', () => {
      file_find.openBase();
    });
    
    function progress_add(){
      document.querySelector('progress').value += 1
    }

    function progress_result(value){
      document.querySelector('progress').value = 0
      document.querySelector('progress').max = value
    }

    function additems(itme_name) {
      /**
      <div>
        <input type="checkbox" id="item">
        <label for="item">[대기중]</label>
        <label for="item">파일</label>
      </div>
      <input class="file" style="width:600px;"></input>
      <button class="run2" onclick="additems()">추가</button>
          <button class="run2" onclick="additems('test')">추가</button>
      <button class="run3" onclick="chkItems()">체크아이템</button>
      <button class="run4" onclick="setStatus('item2','완료')">상태변경</button>
      <link rel="stylesheet" type="text/css" href="loding.css" />
        <div class="loading-container" style="display:none;">
        <div class="loading"></div>
        <div id="loading-text">loading</div>
      </div> style="display: none"

            <button class="run2" onclick="additems('test')">추가</button>
      <button class="run2" onclick="refAdd('test',['L.fasta','S.fasta','M.fasta'])">추가</button>
      <button class="run3" onclick="chkItems()">체크아이템</button>
      **/

      itme_index += 1
      let itme_id = 'item' + itme_index
      let root = document.querySelector("div.listview");
      let newDiv = document.createElement("div");
      newDiv.id = itme_id
      root.appendChild(newDiv);
      let newInput = document.createElement("input");
      newInput.className = "disabled-event"
      newInput.type = 'checkbox'
      newInput.id = itme_id
      newInput.value = itme_name
      newInput.checked = true
      newDiv.appendChild(newInput);
      let newlabel = document.createElement("label");
      let newContent = document.createTextNode('[ 대기 중 ] ');
      newlabel.appendChild(newContent);

      newDiv.appendChild(newlabel);

      let newlabel2 = document.createElement("label");
      let newContent2 = document.createTextNode(itme_name);
      newlabel2.appendChild(newContent2);

      newDiv.appendChild(newlabel2);

      let newSelect = document.createElement("select");
      newSelect.className = "disabled-event"
      let ref_divs = document.querySelectorAll("div.refs > div").forEach((ref) => {
        ref_id = ref.id
        newOption = document.createElement("option");
        optionContent = document.createTextNode(ref_id)
        newOption.value = ref_id
        newOption.appendChild(optionContent)
        newSelect.appendChild(newOption)
        newDiv.appendChild(newSelect)
      })
      newSelect.style = 'margin: 5px;'
      
      for ( let ref in ref_divs ) {
        //console.log(ref)
        //newOption = document.createElement("option");
        //optionContent = document.createTextNode(test1234[test123])
        //newOption.value = test1234[test123]
        //newOption.appendChild(optionContent)
        //newSelect.appendChild(newOption)
        //newDiv.appendChild(newSelect)
      }


    }

    function refAdd(ref_name, ref_files) {
      
      let root = document.querySelector("div.refs");

      let newDiv = document.createElement("div");
      newDiv.id = ref_name
      root.appendChild(newDiv);
      for ( ref_file in ref_files ) {

        newlabel = document.createElement("label");
        if ( ref_files[ref_file].includes('_L.fasta') == true || ref_files[ref_file].includes('_L_') == true ) {
          newlabel.id = 'L'
        } else if ( ref_files[ref_file].includes('M.fasta') == true || ref_files[ref_file].includes('_M_') == true) {
          newlabel.id = 'M'
        } else if ( ref_files[ref_file].includes('S.fasta') == true || ref_files[ref_file].includes('_S_') == true) {
          newlabel.id = 'S'
        } else {
          break
        }
        newContent = document.createTextNode(ref_files[ref_file]);
        newlabel.appendChild(newContent);
        newDiv.appendChild(newlabel);
      }


    }

    function chkItems(nextstrain) {
      let checkbox_list = $('div.listview input')
      let basePath = document.querySelector('div.config input#basePath').value
      let dataPath = document.querySelector('div.config input#dataPath').value
      let threshold = document.querySelector('input#threshold').value
      
      let virus = document.querySelector('div.sub-option input#virus').value
      let accession = document.querySelector('div.sub-option input#accession').value
      let date = document.querySelector('div.sub-option input#date').value
      
      let host = document.querySelector('div.sub-option input#host').value
      let region = document.querySelector('div.sub-option input#region').value
      let country = document.querySelector('div.sub-option input#country').value
      
      let city = document.querySelector('div.sub-option input#city').value
      let town = document.querySelector('div.sub-option input#town').value
      let db = document.querySelector('div.sub-option input#db').value
      
      let author = document.querySelector('div.sub-option input#author').value
      let url = document.querySelector('div.sub-option input#url').value
      let title = document.querySelector('div.sub-option input#title').value
      
      let journal = document.querySelector('div.sub-option input#journal').value
      let paper_url = document.querySelector('div.sub-option input#paper_url').value

      result = []
      for (let item of checkbox_list) {
        if (item.checked == true) {
          let value = getValue(item.id)
          
          option = document.querySelector('div#'+item.id+' select').value
          console.log('div.refs div#'+ option +' label#L')
          option_L = document.querySelector('div.refs div#'+ option +' label#L').textContent
          option_M = document.querySelector('div.refs div#'+ option +' label#M').textContent
          option_S = document.querySelector('div.refs div#'+ option +' label#S').textContent
          obj = {
            "itemId": item.id,
            "value": value,
            "threshold": threshold,
            "option": {
              'name': option,
              'L': option_L,
              'M': option_M,
              'S': option_S
            },
            "nextstrain": nextstrain,
            "nextstrain_option": {
              "virus": virus,
              "accession": accession,
              "date": date,
              "host": host,
              "region": region,
              "country": country,
              "city": city,
              "town": town,
              "db": db,
              "author": author,
              "url": url,
              "title": title,
              "journal": journal,
              "paper_url": paper_url
            },
            "basePath": basePath,
            "dataPath": dataPath
          }

          result.push(obj)
        }
      }
      console.log(result)
      if (nextstrain==true){
        showPage(1)
      }
      return result
    }

    function getValue(itemId) {
      let text = document.querySelector('input#'+itemId).getAttribute('value')
      return text
    }

    function setStatus(itemId, status) {
      document.querySelector('div.listview div#'+itemId+' label').textContent = status
    }

    function elementDisabled(value) {
      console.log(value)
      let button_list = $('.disabled-event')
      for (let item of button_list) {
        console.log(item)
        item.disabled = value
      }
    }


    function allSelect() {
      let checkbox_list = $('div.listview input')
      check_true = false
      for (let item of checkbox_list) {
        if (item.checked == false) {
          check_true = true
        }
      }
      for (let item of checkbox_list) {
        item.checked = check_true
      }
    }

    function deleteItems() {
      let checkbox_list = $('div.listview input')
      for (let item of checkbox_list) {
        if (item.checked == true) {
          let itemId = item.id
          document.querySelector('div.listview div#'+itemId).remove()
        }
      }
    }

    function showOption() {
      let div_option = document.querySelector('div.sub-option')
      let display_none = div_option.getAttribute('style').includes('display: none')

      if ( display_none == true ) {
        div_option.style.display = 'block'
      } else {
        div_option.style.display = 'none'
      }
    }

    function showPage(step) {
      let page_list = $('div.step-page')
      for (let item of page_list) {
        let display_none = item.getAttribute('style').includes('display: none')
        if ( display_none == false ) {
          item.style.display = 'none'
        }
      }
      console.log('div.step-'+step)
      let div_option = document.querySelector('div.step-'+step)
      console.log(div_option)
      div_option.style.display = 'block'
    }

  </script>
</html>